# ADR-051: Client-Server Sync Protocol

- **Status:** âœ… Decidido
- **Date:** 27-feb-2026
- **Deciders:** PO (Sergio), Arquitecto AICE
- **Related:** ADR-049 (Server-Side Scoring), ADR-050 (Event Schema)

## DecisiÃ³n

El cliente envÃ­a eventos en tiempo real. El servidor siempre procesa y devuelve el estado completo. El cliente decide cuÃ¡ndo MOSTRAR al usuario segÃºn los triggers definidos en SKILL.md Â§8/Â§12.

## Protocolo

### Flujo normal (online)

```
Agente detecta evento puntuable
  â†’ Clasifica (tipo, dominio, severidad, patrÃ³n)
  â†’ POST /api/events al hub
  â†’ Hub procesa (delta, streak, caps, etc.)
  â†’ Hub responde con estado completo
  â†’ Cliente cachea en confidence.json
  â†’ Cliente muestra segÃºn trigger:
      Nivel 1 (breve): auto-score, task-complete, idea-validate
      Nivel 2 (tabla): puntÃºa, cada 5 evals, checkpoint, buenas noches
```

### Flujo offline (sin conexiÃ³n)

```
Agente detecta evento puntuable
  â†’ Clasifica
  â†’ Guarda en cola local (pendingEvents en confidence.json)
  â†’ Muestra "ğŸ“Š [pending] TECH error medio | HALLUCINATION"
  â†’ Al reconectar: envÃ­a cola en orden cronolÃ³gico
  â†’ Hub procesa secuencialmente (respetando rate limits)
  â†’ Cliente actualiza cachÃ© con estado final
```

**Ventana offline:** El hub acepta eventos con timestamp hasta 7 dÃ­as en el pasado. MÃ¡s allÃ¡ â†’ rechazado.

### Triggers de visualizaciÃ³n (sin cambio vs SKILL.md Â§12)

| Trigger | QuÃ© envÃ­a al hub | QuÃ© muestra al usuario |
|---------|-----------------|----------------------|
| auto-score | 1 evento | Nivel 1 (una lÃ­nea) |
| task-complete | 1+ eventos | Nivel 1 (una lÃ­nea por dominio) |
| idea-validate | 1 evento (user side) | Nivel 1 |
| puntÃºa | 1+ eventos (agent+user) | Nivel 2 (tabla completa) |
| cada 5 evals | (automÃ¡tico) | Nivel 2 (tabla completa) |
| checkpoint / buenas noches | (automÃ¡tico) | Nivel 2 (tabla completa) |

## Consecuencias

- El hub siempre tiene el estado autoritativo
- `confidence.json` local es una cachÃ©, no la fuente de verdad
- Offline funciona con degradaciÃ³n graceful (cola + sync posterior)
- La experiencia del usuario no cambia â€” mismos triggers, mismos formatos
- Rate limiting se aplica server-side (el cliente no puede bypassearlo)
